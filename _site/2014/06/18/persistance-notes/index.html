<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

    <title>
      
        Persistence Notes &middot; PCS
      
    </title>

    <script type="text/javascript" src="../scripts/jquery-2.1.0.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="../css/master.css">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  </head>

  <body class="pure-g">
    <header class="pure-u-1">
      <nav class="pure-menu pure-menu-open pure-menu-horizontal">
        <ul>
          <li>
            <a href="/">JavaScript Evening</a>
          </li>
          <li>
            <a id="" href="/">About</a>
          </li>
          

          
          
            
              
            
          
            
              
                <li>
                  <a id="" href="/syllabus/">Syllabus</a>
                </li>
              
            
          
            
              
            
          
            
              
                <li>
                  <a id="" href="/curriculum/">Curriculum</a>
                </li>
              
            
          
            
          
            
              
                <li>
                  <a id="" href="/resources/">Resources</a>
                </li>
              
            
          
          <li>
            <a href="http://portlandcodeschool.com/" class="nav-item">PCS Home</a>
          </li>
        </ul>
      </nav>      
    </header>

    <section class="pure-u-1">
      <div class="post">
  <h1 class="post-title">Persistence Notes</h1>
  <span class="post-date">18 Jun 2014</span>
  <span class="post-slides">

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

</span>

  <h2>Class Flow</h2>

<ul>
<li>While there&#39;s a ton of information on SQL and we can really go deep into
this, the material is mostly written for them to be able to come back to. We
want to get through this part of the material relatively quickly and move on
to using PostgreSQL via Node.js.</li>
<li>The idea is to walk through each SQL example having the students following
along.</li>
<li>Have the students do at least the first two SQL challenges. The others should
be left as advanced exercises.</li>
<li>Move into Bookshelf in the early afternoon.</li>
</ul>

<h2>PostgreSQL</h2>

<p>Do we need to?</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">initdb /usr/local/var/postgres -E utf8</code></pre></div>

<p>Try to get the students to figure out how to use <code>psql</code> on their own:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">psql # psql: FATAL:  database &quot;wbyoung&quot; does not exist
psql --help
psql -l
psql postgres</code></pre></div>

<p>Once they have it going, they should be able to get help via <code>\h</code> and <code>\?</code>. We
want to work our way to <code>create database test;</code> and <code>\c test</code>.</p>

<h2>Solution to Relationships</h2>

<div class="highlight"><pre><code class="language-sql" data-lang="sql">create table people (id serial primary key, name varchar(255), gender varchar(255));
create table relations (person_id int references people(id),  parent_id int references people(id));
insert into people (id, name, gender) values (1, &#39;Tim&#39;, &#39;male&#39;), (2, &#39;Lucy&#39;, &#39;female&#39;), (3, &#39;Walter&#39;, &#39;male&#39;), (4, &#39;Susan&#39;, &#39;female&#39;), (5, &#39;Debroah&#39;, &#39;female&#39;), (6, &#39;Thomas&#39;, &#39;male&#39;), (7, &#39;William&#39;, &#39;male&#39;), (8, &#39;Catherine&#39;, &#39;female&#39;), (9, &#39;Doug&#39;, &#39;female&#39;), (10, &#39;Jane&#39;, &#39;female&#39;), (11, &#39;Sally&#39;, &#39;female&#39;), (12, &#39;Barb&#39;, &#39;female&#39;), (13, &#39;Larry&#39;, &#39;male&#39;), (14, &#39;Katy&#39;, &#39;female&#39;), (25, &#39;Matt&#39;, &#39;male&#39;), (15, &#39;Rachel&#39;, &#39;female&#39;), (16, &#39;Michelle&#39;, &#39;female&#39;), (17, &#39;Ashley&#39;, &#39;female&#39;), (18, &#39;Jessica&#39;, &#39;female&#39;), (19, &#39;Peter&#39;, &#39;male&#39;), (20, &#39;Joe&#39;, &#39;male&#39;), (21, &#39;Andrew&#39;, &#39;male&#39;), (22, &#39;Melissa&#39;, &#39;female&#39;), (23, &#39;Jake&#39;, &#39;male&#39;), (24, &#39;Tiffany&#39;, &#39;female&#39;);
insert into relations values (1, 3), (1, 4), (2, 3), (2, 4), (3, 7), (3, 8), (4, 5), (4, 6), (9, 7), (9, 8), (10, 7), (10, 8), (11, 7), (11, 8), (12, 5), (12, 6), (13, 5), (13, 6), (14, 12), (15, 12), (25, 12), (16, 13), (17, 13), (18, 9), (19, 9), (20, 10), (21, 10), (22, 11), (23, 11), (24, 11);

-- get all parents for a person with a given id
select parents.*
from people
left join relations on people.id = relations.person_id
left join people parents on parents.id = relations.parent_id
where people.id = 1;

-- get mother for a person with a given id
select parents.*
from people
left join relations on people.id = relations.person_id
left join people parents on parents.id = relations.parent_id
where people.id = 1 and parents.gender = &#39;female&#39;;

-- get all children for a person with a given id
select children.*
from people
left join relations children_relations on people.id = children_relations.parent_id
left join people children on children.id = children_relations.person_id
where people.id = 3;

-- get all siblings for a person with a given id
select distinct siblings.*
from people
left join relations on relations.person_id = people.id
left join relations sibling_relations on sibling_relations.parent_id = relations.parent_id
left join people siblings on siblings.id = sibling_relations.person_id
where people.id != siblings.id and people.id = 1;

-- get all grandparents for a person with a given id
select grandparents.*
from people
left join relations on relations.person_id = people.id
left join relations parent_relations on relations.parent_id = parent_relations.person_id
left join people grandparents on grandparents.id = parent_relations.parent_id
where people.id = 1;

-- get maternal grandmother for a person with a given id
select grandparents.*
from people
left join relations on relations.person_id = people.id
left join relations parent_relations on relations.parent_id = parent_relations.person_id
left join people parents on parents.id = parent_relations.person_id
left join people grandparents on grandparents.id = parent_relations.parent_id
where parents.gender = &#39;female&#39; and grandparents.gender = &#39;female&#39; and people.id = 1;


-- get all grandchildren for a person with a given id
select grandchildren.*
from people
left join relations children_relations on people.id = children_relations.parent_id
left join relations grandchildren_relations on children_relations.person_id = grandchildren_relations.parent_id
left join people grandchildren on grandchildren.id = grandchildren_relations.person_id
where people.id = 7;</code></pre></div>

<h2>Bookshelf</h2>

<p>Node.js won&#39;t exit when using Bookshelf.js unless you close all open database
connections:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">Country.forge({ name: &#39;Canada&#39; }).save().then(function(country) {
  // do something with the new country
})
.done(function() {
  bookshelf.knex.client.pool.destroy();
});</code></pre></div>

<p>Empty collection containers can be created like so:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">var Countries = bookshelf.Collection.extend({
  model: Country
});
var countries = new Countries(); // or Country.collection();

var Cities = bookshelf.Collection.extend({
  model: City
});
var cities = new Cities(); // or City.collection();</code></pre></div>

<h2>Testing: Spies &amp; Mocks</h2>

<p>These were discussed a bit yesterday.</p>


</div>



    </section>

    <footer class="pure-u-1">
      &copy; 2014. All rights reserved.
      <span>v0.0.1</span>
    </footer>
  </body>
</html>
