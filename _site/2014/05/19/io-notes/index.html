<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

    <title>
      
        Callbacks &amp; I/O Notes &middot; PCS
      
    </title>

    <script type="text/javascript" src="../scripts/jquery-2.1.0.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="../css/master.css">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  </head>

  <body class="pure-g">
    <header class="pure-u-1">
      <nav class="pure-menu pure-menu-open pure-menu-horizontal">
        <ul>
          <li>
            <a href="/">JavaScript Evening</a>
          </li>
          <li>
            <a id="" href="/">About</a>
          </li>
          

          
          
            
              
            
          
            
              
                <li>
                  <a id="" href="/syllabus/">Syllabus</a>
                </li>
              
            
          
            
              
            
          
            
              
                <li>
                  <a id="" href="/curriculum/">Curriculum</a>
                </li>
              
            
          
            
          
            
              
                <li>
                  <a id="" href="/resources/">Resources</a>
                </li>
              
            
          
          <li>
            <a href="http://portlandcodeschool.com/" class="nav-item">PCS Home</a>
          </li>
        </ul>
      </nav>      
    </header>

    <section class="pure-u-1">
      <div class="post">
  <h1 class="post-title">Callbacks &amp; I/O Notes</h1>
  <span class="post-date">19 May 2014</span>
  <span class="post-slides">

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

</span>

  <h2>Class Flow</h2>

<ul>
<li>Start right into callbacks</li>
<li>Implement the functions for baking a cake while the students help gude the
implementations (see below for full solutions).</li>
<li>Explain the two bad options for cake baking.</li>
<li>Have students do some of the challenges. There are solutions below to each
of the challenges.<br>
Present the JavaScript that&#39;s wrong below for the <code>setReminder</code> challenge.
Introduce Lo-Dash through this example, but also ask students to share what&#39;s
wrong with the code.</li>
</ul>

<h2>Callbacks</h2>

<h3>Baking A Cake</h3>

<p>This example illustrates that we have two bad options.</p>

<ol>
<li>We set the timer then take the cake out immediately. We never actually
notice when the timer goes off.</li>
<li>We can do nothing while the cake bakes. We &#39;sleep&#39; during that time and
aren&#39;t productive.</li>
</ol>

<p>The take one gets to the point of illustrating the two bad options. Take two
tries to clearly illustrate callbacks by making separate functions instead of
anonymous functions as arguments, but you should move the code around to show
what the anonymous function version looks like. The slides will show that.</p>

<h4>Code Take 1</h4>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">var sleep = require(&#39;sleep&#39;).sleep;

var preheatOven = function(temp) {
  console.log(&#39;Preheating the oven to %s.&#39;, temp);
};

var mix = function(ingredients) {
  var formatted = ingredients;
  if (ingredients.length &gt; 1) {
    formatted = ingredients.slice(0); // copy
    formatted[ingredients.length - 1] =
      &#39;and &#39; + formatted[ingredients.length - 1];
  }
  console.log(&#39;Mixing %s.&#39;, formatted.join(&#39;, &#39;));
  return { mixture: ingredients };
};

var pour = function(cookware, liquid) {
  console.log(&#39;Pouring %j into %j.&#39;, liquid, cookware);
  return { cookware: cookware, containing: liquid };
};

var ovenAddItem = function(item) {
  console.log(&#39;Putting %j in the oven.&#39;, item);
};

var ovenSetTimer = function(duration) {
  console.log(&#39;Setting oven timer to %s&#39;, duration);
  console.log(&#39;We will wait %ss to simulate %s.&#39;, parseInt(duration), duration);
  sleep(parseInt(duration));
  console.log(&#39;The timer is going off!&#39;);
};

var ovenRemoveItem = function(item) {
  console.log(&#39;Removing %j from the oven.&#39;, item);
};

var decorate = function(item, decoration) {
  console.log(&#39;Decorating %j with %j&#39;, item, decoration);
};

// prep work
preheatOven(&#39;350deg&#39;);

// make the cake batter
var batter = mix([&#39;flour&#39;, &#39;eggs&#39;, &#39;butter&#39;]);
var pan = {
  type: &#39;pan&#39;,
  diameter: &#39;9in&#39;,
  shape: &#39;round&#39;
};
var cake = pour(pan, batter);

// bake the cake
ovenAddItem(cake);
ovenSetTimer(&#39;30min&#39;);
ovenRemoveItem(cake);

// frost the cake
var frosting = mix([&#39;sugar&#39;, &#39;butter&#39;, &#39;cocoa powder&#39;]);
decorate(cake, frosting);</code></pre></div>

<h4>Code Take 2</h4>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">var preheatOven = function(temp) {
  console.log(&#39;Preheating the oven to %s.&#39;, temp);
};

var mix = function(ingredients) {
  var formatted;
  if (ingredients.length &lt;= 1) { formatted = ingredients[0]; }
  else {
    formatted = ingredients.slice(0, ingredients.length - 1).join(&#39;, &#39;) + &#39; and &#39; + ingredients[ingredients.length - 1];
  }
  console.log(&#39;Mixing %s.&#39;, formatted);
  return { mixture: ingredients };
};

var pour = function(cookware, liquid) {
  console.log(&#39;Pouring %j into %j.&#39;, liquid, cookware);
  return { cookware: cookware, containing: liquid };
};

var ovenAddItem = function(item) {
  console.log(&#39;Putting %j in the oven.&#39;, item);
};

var ovenSetTimer = function(duration, callback) {
  console.log(&#39;Setting oven timer to %s&#39;, duration);
  console.log(&#39;We will wait %ss to simulate %s.&#39;, parseInt(duration), duration);
  setTimeout(function() {
    console.log(&#39;The timer is going off!&#39;);
    callback();
  }, parseInt(duration) * 1000);
};

var ovenRemoveItem = function(item) {
  console.log(&#39;Removing %j from the oven.&#39;, item);
};

var decorate = function(item, decoration) {
  console.log(&#39;Decorating %j with %j&#39;, item, decoration);
};

// prep work
preheatOven(&#39;350deg&#39;);

// make the cake batter
var batter = mix([&#39;flour&#39;, &#39;eggs&#39;, &#39;butter&#39;]);
var pan = {
  type: &#39;pan&#39;,
  diameter: &#39;9in&#39;,
  shape: &#39;round&#39;
};
var cake = pour(pan, batter);
var frosting = null;

var whenTimerGoesOff = function() {
  ovenRemoveItem(cake);
  decorate(cake, frosting);
};

var beforeTimerGoesOff = function() {
  // frost the cake
  frosting =  mix([&#39;sugar&#39;, &#39;butter&#39;, &#39;cocoa powder&#39;]);
};

// bake the cake
ovenAddItem(cake);
ovenSetTimer(&#39;30min&#39;, whenTimerGoesOff);
beforeTimerGoesOff();</code></pre></div>

<h4>Test Driven Code</h4>

<p>This also includes a test for making the callback optional.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">describe(&#39;ovenSetTimer()&#39;, function() {
  it(&#39;calls the callback&#39;, function(done) {
    ovenSetTimer(&#39;0s&#39;, done);
  });
  it(&#39;works with no callback&#39;, function(done) {
    ovenSetTimer(&#39;0s&#39;);
    setTimeout(done, 0);
  });
});</code></pre></div>

<h3>Challenges</h3>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">var setReminder = function(date, callback) {
  setTimeout(callback, date.getTime() - Date.now());
};</code></pre></div>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">var start = Date.now();
_.each(_.range(10), function(i) {
  setReminder(new Date(start + i * 1000), function() {
    console.log(i + 1);
  });
});</code></pre></div>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">_.each(_.range(10), function(i) {
  setTimeout(function() {
    console.log(i + 1);
  }, i * 1000);
});</code></pre></div>

<p>Also, for students who tried the stopwatch with <code>setReminder</code>, ask them to
identify what&#39;s wrong with this code:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">_.each(_.range(2000), function(i) {
  setReminder(new Date(Date.now() + i * 1000), function() {
    console.log(i + 1);
  });
});</code></pre></div>

<p>The problem is that numbers later in the list will not be scheduled relative to
the first number. They&#39;re scheduled relative to the time that the code executes
that iteration of the loop. It took my computer scheduling about 200,000 items
before this caused a skew of roughly 1 second.</p>

<p>Natural language processing:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">var chrono = require(&#39;chrono-node&#39;);
var setReminder = function(date, callback) {
  if (!(date instanceof Date)) {
    date = chrono.parseDate(date);
  }
  setTimeout(callback, date.getTime() - Date.now());
};
setReminder(&#39;3:10pm&#39;, function() { console.log(&#39;done!&#39;); });</code></pre></div>

<h2>I/O</h2>

<h3>Challenge Solution</h3>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">#!/usr/bin/env node

var fs = require(&#39;fs&#39;);
var program = require(&#39;commander&#39;);

program
  .version(&#39;0.0.1&#39;)
  .usage(&#39;[options] &lt;file1&gt; &lt;file2&gt;&#39;)
  .option(&#39;-n, --number&#39;, &#39;Report just the number of words&#39;)
  .option(&#39;-v, --verbose&#39;, &#39;Be more verbose, report timing information&#39;)
  .parse(process.argv);


if (program.args.length != 2) {
  program.help();
}

var time = function(name) {
  var start = Date.now();
  return function() {
    if (program.verbose) {
      console.log(&#39;[time] %s: %dms&#39;, name, Date.now() - start);
    }
  };
};

var sharedWords = function(contents1, contents2) {
  var words1 = contents1.split(&#39; &#39;);
  var words2 = contents2.split(&#39; &#39;);

  var knownWords = {};
  words1.forEach(function(word) {
    knownWords[word] = true;
  });

  var sharedWords = [];
  words2.forEach(function(word) {
    if (knownWords[word]) {
      sharedWords.push(word);
      delete knownWords[word]; // only report word once
    }
  });
  return sharedWords;
};

var sharedWordsBigOOfNSquared = function(contents1, contents2) {
  var words1 = contents1.split(&#39; &#39;);
  var words2 = contents2.split(&#39; &#39;);
  var sharedWords = [];

  words1.forEach(function(word1) {
    var reported = false;
    sharedWords.every(function(reportedWord) {
      if (word1 == reportedWord) {
        reported = true;
        return false;
      }
      return true;
    });
    if (!reported) {
      words2.every(function(word2) {
        if (word1 == word2) {
          sharedWords.push(word1);
          return false;
        }
        return true;
      });
    }
  });

  return sharedWords;
};

var file1 = {
  path: program.args[0],
  contents: null
};

var file2 = {
  path: program.args[1],
  contents: null
};

var doneReading = time(&#39;read the files&#39;);
var compareIfBothFilesRead = function() {
  if (file1.contents &amp;&amp; file2.contents) {
    doneReading();

    var done = time(&#39;word comparison&#39;);
    var shared = sharedWords(file1.contents, file2.contents);
    done();

    if (program.number) { console.log(&#39;%d words in common.&#39;, shared.length); }
    else {
      shared.forEach(function(word) {
        console.log(word);
      });
    }
  }
};

fs.readFile(file1.path, { encoding: &#39;utf8&#39; }, function(err, contents) {
  file1.contents = contents;
  compareIfBothFilesRead();
});

fs.readFile(file2.path, { encoding: &#39;utf8&#39; }, function(err, contents) {
  file2.contents = contents;
  compareIfBothFilesRead();
});</code></pre></div>

<h3>Challenge Inputs</h3>

<p>This code was used to create rather large text files for the compare words
problem. 10,000 words were created in each of two files.</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript">var fs = require(&#39;fs&#39;);

var wordCount = parseInt(process.argv[2]);

if (process.argv.length != 3) {
  console.log(&#39;useage: create-words number&#39;);
  process.exit(1);
}

fs.readFile(&#39;/usr/share/dict/words&#39;, { encoding: &#39;utf8&#39; }, function(err, contents) {
  var lines = contents.split(&#39;\n&#39;);
  for (var i = 0; i &lt; wordCount; i++) {
    var word = lines[Math.floor(Math.random() * lines.length)].trim();
    process.stdout.write(word);
    process.stdout.write(&#39; &#39;);
  }
  process.stdout.write(&#39;\n&#39;);
});</code></pre></div>


</div>



    </section>

    <footer class="pure-u-1">
      &copy; 2014. All rights reserved.
      <span>v0.0.1</span>
    </footer>
  </body>
</html>
